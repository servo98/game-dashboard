name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Servicio a deployar manualmente'
        required: true
        type: choice
        options:
          - all
          - backend
          - dashboard
          - bot
          - nginx

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detectar cambios (solo en push automático)
        id: changed
        if: github.event_name == 'push'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'games/**'
              - 'docker-compose.yml'
            dashboard:
              - 'dashboard/**'
              - 'docker-compose.yml'
            bot:
              - 'bot/**'
              - 'docker-compose.yml'
            commands:
              - 'bot/src/commands/**'
              - 'bot/src/register.ts'
            nginx:
              - 'nginx/nginx.conf'
            static:
              - 'static-site/**'
            games:
              - 'games/**'

      - name: Rebuild backend
        if: |
          (github.event_name == 'push' && steps.changed.outputs.backend == 'true') ||
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'backend' || inputs.service == 'all'))
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            docker compose build --build-arg CACHE_BUST=$(git rev-parse HEAD) backend
            docker compose up -d backend

      - name: Reseed DB (si cambiaron games/)
        if: |
          (github.event_name == 'push' && steps.changed.outputs.games == 'true') ||
          (github.event_name == 'workflow_dispatch' && inputs.service == 'all')
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose exec backend bun run src/seed.ts

      - name: Rebuild dashboard
        if: |
          (github.event_name == 'push' && steps.changed.outputs.dashboard == 'true') ||
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'dashboard' || inputs.service == 'all'))
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            docker compose build --build-arg CACHE_BUST=$(git rev-parse HEAD) dashboard
            docker compose up -d dashboard

      - name: Rebuild bot
        if: |
          (github.event_name == 'push' && steps.changed.outputs.bot == 'true') ||
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'bot' || inputs.service == 'all'))
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            docker compose build --build-arg CACHE_BUST=$(git rev-parse HEAD) bot
            docker compose up -d bot

      - name: Registrar slash commands
        if: github.event_name == 'push' && steps.changed.outputs.commands == 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose run --rm bot bun run src/register.ts

      - name: Recargar nginx (sin rebuild)
        if: |
          (github.event_name == 'push' && steps.changed.outputs.nginx == 'true') ||
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'nginx' || inputs.service == 'all'))
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            docker compose exec nginx nginx -s reload

      - name: Actualizar sitio estático
        if: github.event_name == 'push' && steps.changed.outputs.static == 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            echo "static-site actualizado (nginx lo sirve directo)"

      - name: Notificar deploy exitoso
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%s)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=%an)
          curl -s -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"✅ Deploy exitoso\",
              \"description\": \"**${COMMIT_MSG}**\",
              \"color\": 3066993,
              \"fields\": [
                { \"name\": \"Commit\", \"value\": \"[\`${COMMIT_SHA}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true },
                { \"name\": \"Autor\", \"value\": \"${AUTHOR}\", \"inline\": true },
                { \"name\": \"Trigger\", \"value\": \"${{ github.event_name }}\", \"inline\": true }
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" "${{ secrets.DISCORD_DEPLOY_WEBHOOK }}"

      - name: Notificar deploy fallido
        if: failure()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%s)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          curl -s -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"❌ Deploy fallido\",
              \"description\": \"**${COMMIT_MSG}**\",
              \"color\": 15158332,
              \"fields\": [
                { \"name\": \"Commit\", \"value\": \"[\`${COMMIT_SHA}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true },
                { \"name\": \"Logs\", \"value\": \"[Ver logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true }
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" "${{ secrets.DISCORD_DEPLOY_WEBHOOK }}"
