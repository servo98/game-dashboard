name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Servicio a deployar manualmente'
        required: true
        type: choice
        options:
          - all
          - backend
          - dashboard
          - bot
          - nginx

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Notificar deploy iniciado
        env:
          BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.DISCORD_DEPLOY_CHANNEL_ID }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          EVENT: ${{ github.event_name }}
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHANNEL_ID" ]; then exit 0; fi
          MSG=$(git log -1 --pretty=%s | sed 's/"/\\"/g')
          SHORT=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=%an | sed 's/"/\\"/g')
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          JSON=$(cat <<EOFJ
          {"embeds":[{"title":"ðŸš€ Deploy iniciado","description":"**${MSG}**","color":3447003,"fields":[{"name":"Commit","value":"[${SHORT}](https://github.com/${REPO}/commit/${SHA})","inline":true},{"name":"Autor","value":"${AUTHOR}","inline":true},{"name":"Trigger","value":"${EVENT}","inline":true}],"timestamp":"${TS}"}]}
          EOFJ
          )
          curl -sf -X POST "https://discord.com/api/v10/channels/${CHANNEL_ID}/messages" \
            -H "Authorization: Bot ${BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$JSON"

      - name: Detectar cambios (solo en push automÃ¡tico)
        id: changed
        if: github.event_name == 'push'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'games/**'
              - 'docker-compose.yml'
            dashboard:
              - 'dashboard/**'
              - 'docker-compose.yml'
            bot:
              - 'bot/**'
              - 'docker-compose.yml'
            commands:
              - 'bot/src/commands/**'
              - 'bot/src/register.ts'
            nginx:
              - 'nginx/nginx.conf'
            static:
              - 'static-site/**'
            games:
              - 'games/**'

      - name: Rebuild backend
        if: |
          (github.event_name == 'push' && steps.changed.outputs.backend == 'true') ||
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'backend' || inputs.service == 'all'))
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            docker compose build --build-arg CACHE_BUST=$(git rev-parse HEAD) backend
            docker compose up -d backend

      - name: Reseed DB (si cambiaron games/)
        if: |
          (github.event_name == 'push' && steps.changed.outputs.games == 'true') ||
          (github.event_name == 'workflow_dispatch' && inputs.service == 'all')
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose exec backend bun run src/seed.ts

      - name: Rebuild dashboard
        if: |
          (github.event_name == 'push' && steps.changed.outputs.dashboard == 'true') ||
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'dashboard' || inputs.service == 'all'))
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            docker compose build --build-arg CACHE_BUST=$(git rev-parse HEAD) dashboard
            docker compose up -d dashboard

      - name: Rebuild bot
        if: |
          (github.event_name == 'push' && steps.changed.outputs.bot == 'true') ||
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'bot' || inputs.service == 'all'))
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            docker compose build --build-arg CACHE_BUST=$(git rev-parse HEAD) bot
            docker compose up -d bot

      - name: Registrar slash commands
        if: github.event_name == 'push' && steps.changed.outputs.commands == 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose run --rm bot bun run src/register.ts

      - name: Recargar nginx (sin rebuild)
        if: |
          (github.event_name == 'push' && steps.changed.outputs.nginx == 'true') ||
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'nginx' || inputs.service == 'all'))
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            docker compose exec nginx nginx -s reload

      - name: Actualizar sitio estÃ¡tico
        if: github.event_name == 'push' && steps.changed.outputs.static == 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git fetch origin main
            git reset --hard origin/main
            echo "static-site actualizado (nginx lo sirve directo)"

      - name: Notificar deploy exitoso
        if: success()
        env:
          BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.DISCORD_DEPLOY_CHANNEL_ID }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          EVENT: ${{ github.event_name }}
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHANNEL_ID" ]; then exit 0; fi
          MSG=$(git log -1 --pretty=%s | sed 's/"/\\"/g')
          SHORT=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=%an | sed 's/"/\\"/g')
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          JSON=$(cat <<EOFJ
          {"embeds":[{"title":"âœ… Deploy exitoso","description":"**${MSG}**","color":3066993,"fields":[{"name":"Commit","value":"[${SHORT}](https://github.com/${REPO}/commit/${SHA})","inline":true},{"name":"Autor","value":"${AUTHOR}","inline":true},{"name":"Trigger","value":"${EVENT}","inline":true}],"timestamp":"${TS}"}]}
          EOFJ
          )
          curl -sf -X POST "https://discord.com/api/v10/channels/${CHANNEL_ID}/messages" \
            -H "Authorization: Bot ${BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$JSON"

      - name: Notificar deploy fallido
        if: failure()
        env:
          BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.DISCORD_DEPLOY_CHANNEL_ID }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHANNEL_ID" ]; then exit 0; fi
          MSG=$(git log -1 --pretty=%s | sed 's/"/\\"/g')
          SHORT=$(git rev-parse --short HEAD)
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          JSON=$(cat <<EOFJ
          {"embeds":[{"title":"âŒ Deploy fallido","description":"**${MSG}**","color":15158332,"fields":[{"name":"Commit","value":"[${SHORT}](https://github.com/${REPO}/commit/${SHA})","inline":true},{"name":"Logs","value":"[Ver logs](https://github.com/${REPO}/actions/runs/${RUN_ID})","inline":true}],"timestamp":"${TS}"}]}
          EOFJ
          )
          curl -sf -X POST "https://discord.com/api/v10/channels/${CHANNEL_ID}/messages" \
            -H "Authorization: Bot ${BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$JSON"
