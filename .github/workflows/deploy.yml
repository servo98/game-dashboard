name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Servicio a deployar manualmente'
        required: true
        type: choice
        options:
          - all
          - backend
          - dashboard
          - bot
          - nginx

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. Detect which services need deploying
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.result.outputs.backend }}
      dashboard: ${{ steps.result.outputs.dashboard }}
      bot: ${{ steps.result.outputs.bot }}
      commands: ${{ steps.result.outputs.commands }}
      nginx: ${{ steps.result.outputs.nginx }}
      static: ${{ steps.result.outputs.static }}
      games: ${{ steps.result.outputs.games }}
      any_service: ${{ steps.result.outputs.any_service }}
      services_list: ${{ steps.result.outputs.services_list }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detectar cambios (push)
        id: changed
        if: github.event_name == 'push'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'games/**'
              - 'docker-compose.yml'
            dashboard:
              - 'dashboard/**'
              - 'docker-compose.yml'
            bot:
              - 'bot/**'
              - 'docker-compose.yml'
            commands:
              - 'bot/src/commands/**'
              - 'bot/src/register.ts'
            nginx:
              - 'nginx/nginx.conf'
            static:
              - 'static-site/**'
            games:
              - 'games/**'

      - name: Unificar outputs
        id: result
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            BACKEND="${{ steps.changed.outputs.backend }}"
            DASHBOARD="${{ steps.changed.outputs.dashboard }}"
            BOT="${{ steps.changed.outputs.bot }}"
            COMMANDS="${{ steps.changed.outputs.commands }}"
            NGINX="${{ steps.changed.outputs.nginx }}"
            STATIC="${{ steps.changed.outputs.static }}"
            GAMES="${{ steps.changed.outputs.games }}"
          else
            SVC="${{ inputs.service }}"
            BACKEND=$( [ "$SVC" = "backend" ] || [ "$SVC" = "all" ] && echo true || echo false )
            DASHBOARD=$( [ "$SVC" = "dashboard" ] || [ "$SVC" = "all" ] && echo true || echo false )
            BOT=$( [ "$SVC" = "bot" ] || [ "$SVC" = "all" ] && echo true || echo false )
            COMMANDS="false"
            NGINX=$( [ "$SVC" = "nginx" ] || [ "$SVC" = "all" ] && echo true || echo false )
            STATIC="false"
            GAMES="false"
          fi

          echo "backend=$BACKEND" >> $GITHUB_OUTPUT
          echo "dashboard=$DASHBOARD" >> $GITHUB_OUTPUT
          echo "bot=$BOT" >> $GITHUB_OUTPUT
          echo "commands=$COMMANDS" >> $GITHUB_OUTPUT
          echo "nginx=$NGINX" >> $GITHUB_OUTPUT
          echo "static=$STATIC" >> $GITHUB_OUTPUT
          echo "games=$GAMES" >> $GITHUB_OUTPUT

          SERVICES=""
          [ "$BACKEND" = "true" ] && SERVICES="${SERVICES:+$SERVICES, }backend"
          [ "$DASHBOARD" = "true" ] && SERVICES="${SERVICES:+$SERVICES, }dashboard"
          [ "$BOT" = "true" ] && SERVICES="${SERVICES:+$SERVICES, }bot"
          [ "$NGINX" = "true" ] && SERVICES="${SERVICES:+$SERVICES, }nginx"
          [ "$STATIC" = "true" ] && SERVICES="${SERVICES:+$SERVICES, }static"

          if [ -n "$SERVICES" ]; then
            echo "any_service=true" >> $GITHUB_OUTPUT
          else
            echo "any_service=false" >> $GITHUB_OUTPUT
          fi
          echo "services_list=$SERVICES" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # QUALITY GATE: lint -> typecheck -> test
  # Si lint falla, no gasta minutos en lo demas.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. Lint (whole repo â€” Biome is fast)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npx biome check .

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. Typecheck â€” solo si lint pasa
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  typecheck-backend:
    runs-on: ubuntu-latest
    needs: [lint, detect-changes]
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run typecheck --workspace=backend

  typecheck-dashboard:
    runs-on: ubuntu-latest
    needs: [lint, detect-changes]
    if: needs.detect-changes.outputs.dashboard == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run typecheck --workspace=dashboard

  typecheck-bot:
    runs-on: ubuntu-latest
    needs: [lint, detect-changes]
    if: needs.detect-changes.outputs.bot == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run typecheck --workspace=bot

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. Tests â€” solo si typecheck pasa
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-backend:
    runs-on: ubuntu-latest
    needs: [typecheck-backend, detect-changes]
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npx vitest run --project backend --coverage

  test-dashboard:
    runs-on: ubuntu-latest
    needs: [typecheck-dashboard, detect-changes]
    if: needs.detect-changes.outputs.dashboard == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npx vitest run --project dashboard --coverage

  test-bot:
    runs-on: ubuntu-latest
    needs: [typecheck-bot, detect-changes]
    if: needs.detect-changes.outputs.bot == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npx vitest run --project bot --coverage

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 5. Quality gate â€” resumen antes de deployar
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality-gate:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - lint
      - typecheck-backend
      - typecheck-dashboard
      - typecheck-bot
      - test-backend
      - test-dashboard
      - test-bot
    steps:
      - name: Check results
        run: |
          for result in \
            "${{ needs.lint.result }}" \
            "${{ needs.typecheck-backend.result }}" \
            "${{ needs.typecheck-dashboard.result }}" \
            "${{ needs.typecheck-bot.result }}" \
            "${{ needs.test-backend.result }}" \
            "${{ needs.test-dashboard.result }}" \
            "${{ needs.test-bot.result }}"; do
            if [ "$result" = "failure" ] || [ "$result" = "cancelled" ]; then
              echo "::error::Quality gate failed â€” deploy blocked"
              exit 1
            fi
          done
          echo "All quality checks passed â€” proceeding to deploy"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY â€” solo corre si quality-gate pasa
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 6. Discord: deploy started
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-start:
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Enviar notificaciÃ³n de inicio
        env:
          BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.DISCORD_DEPLOY_CHANNEL_ID }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          EVENT: ${{ github.event_name }}
          RUN_ID: ${{ github.run_id }}
          ANY_SERVICE: ${{ needs.detect-changes.outputs.any_service }}
          SVC_BACKEND: ${{ needs.detect-changes.outputs.backend }}
          SVC_DASHBOARD: ${{ needs.detect-changes.outputs.dashboard }}
          SVC_BOT: ${{ needs.detect-changes.outputs.bot }}
          SVC_COMMANDS: ${{ needs.detect-changes.outputs.commands }}
          SVC_NGINX: ${{ needs.detect-changes.outputs.nginx }}
          SVC_STATIC: ${{ needs.detect-changes.outputs.static }}
          SVC_GAMES: ${{ needs.detect-changes.outputs.games }}
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHANNEL_ID" ]; then exit 0; fi
          MSG=$(git log -1 --pretty=%s | sed 's/"/\\"/g')
          SHORT=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=%an | sed 's/"/\\"/g')
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Build job list â€” always starts with lint + quality-gate
          JOBS="ğŸ”„ lint\\nğŸ”„ quality-gate\\nğŸ”„ sync-code"

          if [ "$SVC_BACKEND" = "true" ]; then
            JOBS="${JOBS}\\nğŸ”„ typecheck-backend\\nğŸ”„ test-backend\\nğŸ”„ deploy-backend"
          fi
          if [ "$SVC_DASHBOARD" = "true" ]; then
            JOBS="${JOBS}\\nğŸ”„ typecheck-dashboard\\nğŸ”„ test-dashboard\\nğŸ”„ deploy-dashboard"
          fi
          if [ "$SVC_BOT" = "true" ]; then
            JOBS="${JOBS}\\nğŸ”„ typecheck-bot\\nğŸ”„ test-bot\\nğŸ”„ deploy-bot"
          fi
          if [ "$SVC_NGINX" = "true" ]; then
            JOBS="${JOBS}\\nğŸ”„ deploy-nginx"
          fi
          if [ "$SVC_STATIC" = "true" ]; then
            JOBS="${JOBS}\\nğŸ”„ deploy-static"
          fi
          if [ "$SVC_GAMES" = "true" ] && [ "$SVC_BACKEND" = "true" ]; then
            JOBS="${JOBS}\\nğŸ”„ reseed-db"
          fi
          if [ "$SVC_COMMANDS" = "true" ] && [ "$SVC_BOT" = "true" ]; then
            JOBS="${JOBS}\\nğŸ”„ register-commands"
          fi

          JOBS="${JOBS}\\nğŸ”„ notify-end"

          if [ "$ANY_SERVICE" = "true" ]; then
            TITLE="ğŸš€ Pipeline Iniciado"
            DESC="**${MSG}**"
          else
            TITLE="ğŸš€ Pipeline Iniciado (sin deploys)"
            DESC="**${MSG}**\\nSolo quality checks â€” ningÃºn servicio cambiÃ³"
          fi

          JSON=$(cat <<EOFJ
          {
            "embeds": [{
              "title": "${TITLE}",
              "description": "${DESC}",
              "color": 3447003,
              "fields": [
                {"name": "Commit", "value": "[\`${SHORT}\`](https://github.com/${REPO}/commit/${SHA})", "inline": true},
                {"name": "Autor", "value": "${AUTHOR}", "inline": true},
                {"name": "Trigger", "value": "${EVENT}", "inline": true},
                {"name": "Jobs a ejecutar", "value": "${JOBS}", "inline": false}
              ],
              "footer": {"text": "game-panel CI/CD"},
              "timestamp": "${TS}"
            }],
            "components": [{
              "type": 1,
              "components": [
                {"type": 2, "style": 5, "label": "Ver en Actions", "url": "https://github.com/${REPO}/actions/runs/${RUN_ID}", "emoji": {"name": "ğŸ”—"}},
                {"type": 2, "style": 5, "label": "Ver Commit", "url": "https://github.com/${REPO}/commit/${SHA}", "emoji": {"name": "ğŸ“"}}
              ]
            }]
          }
          EOFJ
          )
          curl -sf -X POST "https://discord.com/api/v10/channels/${CHANNEL_ID}/messages" \
            -H "Authorization: Bot ${BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$JSON"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 7. Sync code on server (single job to avoid ref lock races)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sync-code:
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-gate]
    if: >-
      !cancelled() &&
      needs.quality-gate.result == 'success' &&
      needs.detect-changes.outputs.any_service == 'true'
    steps:
      - name: Pull latest code on server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            git gc --prune=now -q 2>/dev/null || true
            git fetch origin main
            git reset --hard origin/main
            echo "Synced to $(git rev-parse --short HEAD)"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 8â€“12. Deploy services (parallel, after sync)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-code]
    if: >-
      !cancelled() &&
      needs.sync-code.result == 'success' &&
      needs.detect-changes.outputs.backend == 'true'
    steps:
      - name: Rebuild backend
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose build --build-arg CACHE_BUST=$(git rev-parse HEAD) backend
            docker compose up -d --force-recreate --no-deps backend

  deploy-dashboard:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-code]
    if: >-
      !cancelled() &&
      needs.sync-code.result == 'success' &&
      needs.detect-changes.outputs.dashboard == 'true'
    steps:
      - name: Rebuild dashboard
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose build --build-arg CACHE_BUST=$(git rev-parse HEAD) dashboard
            docker compose up -d --no-deps dashboard

  deploy-bot:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-code]
    if: >-
      !cancelled() &&
      needs.sync-code.result == 'success' &&
      needs.detect-changes.outputs.bot == 'true'
    steps:
      - name: Rebuild bot
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose build --build-arg CACHE_BUST=$(git rev-parse HEAD) bot
            docker compose up -d --no-deps bot

  deploy-nginx:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-code]
    if: >-
      !cancelled() &&
      needs.sync-code.result == 'success' &&
      needs.detect-changes.outputs.nginx == 'true'
    steps:
      - name: Recargar nginx
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose exec nginx nginx -s reload

  deploy-static:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-code]
    if: >-
      !cancelled() &&
      needs.sync-code.result == 'success' &&
      needs.detect-changes.outputs.static == 'true'
    steps:
      - name: Actualizar sitio estÃ¡tico
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            echo "static-site actualizado (nginx lo sirve directo)"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 12. Reseed DB (after backend deploys)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  reseed-db:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-backend]
    if: >-
      needs.deploy-backend.result == 'success' &&
      needs.detect-changes.outputs.games == 'true'
    steps:
      - name: Reseed DB
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose exec backend bun run src/seed.ts

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 13. Register slash commands (after bot deploys)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  register-commands:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-bot]
    if: >-
      needs.deploy-bot.result == 'success' &&
      needs.detect-changes.outputs.commands == 'true'
    steps:
      - name: Registrar slash commands
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/game-panel
            docker compose run --rm bot bun run src/register.ts

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 14. Discord: deploy finished (always runs)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-end:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - detect-changes
      - lint
      - typecheck-backend
      - typecheck-dashboard
      - typecheck-bot
      - test-backend
      - test-dashboard
      - test-bot
      - quality-gate
      - sync-code
      - deploy-backend
      - deploy-dashboard
      - deploy-bot
      - deploy-nginx
      - deploy-static
      - reseed-db
      - register-commands
    steps:
      - uses: actions/checkout@v4

      - name: Enviar notificaciÃ³n final
        env:
          BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.DISCORD_DEPLOY_CHANNEL_ID }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
          LINT: ${{ needs.lint.result }}
          TC_BACKEND: ${{ needs.typecheck-backend.result }}
          TC_DASHBOARD: ${{ needs.typecheck-dashboard.result }}
          TC_BOT: ${{ needs.typecheck-bot.result }}
          T_BACKEND: ${{ needs.test-backend.result }}
          T_DASHBOARD: ${{ needs.test-dashboard.result }}
          T_BOT: ${{ needs.test-bot.result }}
          D_BACKEND: ${{ needs.deploy-backend.result }}
          D_DASHBOARD: ${{ needs.deploy-dashboard.result }}
          D_BOT: ${{ needs.deploy-bot.result }}
          D_NGINX: ${{ needs.deploy-nginx.result }}
          D_STATIC: ${{ needs.deploy-static.result }}
          D_RESEED: ${{ needs.reseed-db.result }}
          D_COMMANDS: ${{ needs.register-commands.result }}
          ANY_SERVICE: ${{ needs.detect-changes.outputs.any_service }}
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHANNEL_ID" ]; then exit 0; fi

          LINES=""
          FAILED=""
          CANCELLED=""

          add_line() {
            local name=$1 result=$2
            case "$result" in
              success)   LINES="${LINES}\\nâœ… ${name}" ;;
              failure)   LINES="${LINES}\\nâŒ ${name}"; FAILED="${FAILED:+${FAILED}, }${name}" ;;
              cancelled) LINES="${LINES}\\nâšª ${name} (cancelado)"; CANCELLED="true" ;;
              skipped)   ;;
            esac
          }

          # Quality checks
          add_line "Lint" "$LINT"
          add_line "Typecheck backend" "$TC_BACKEND"
          add_line "Typecheck dashboard" "$TC_DASHBOARD"
          add_line "Typecheck bot" "$TC_BOT"
          add_line "Test backend" "$T_BACKEND"
          add_line "Test dashboard" "$T_DASHBOARD"
          add_line "Test bot" "$T_BOT"
          # Deploy
          add_line "Deploy backend" "$D_BACKEND"
          add_line "Deploy dashboard" "$D_DASHBOARD"
          add_line "Deploy bot" "$D_BOT"
          add_line "Deploy nginx" "$D_NGINX"
          add_line "Deploy static" "$D_STATIC"
          add_line "Reseed DB" "$D_RESEED"
          add_line "Register commands" "$D_COMMANDS"

          # Remove leading \n
          LINES="${LINES#\\n}"

          if [ -z "$LINES" ]; then LINES="Solo quality checks â€” ningÃºn servicio cambiÃ³"; fi

          MSG=$(git log -1 --pretty=%s | sed 's/"/\\"/g')
          SHORT=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=%an | sed 's/"/\\"/g')
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          if [ -n "$FAILED" ]; then
            TITLE="âŒ Pipeline Fallido"
            COLOR=15158332
            DESC="FallÃ³ en: **${FAILED}**\\n\\n**${MSG}**"
          elif [ "$CANCELLED" = "true" ]; then
            TITLE="âšª Pipeline Cancelado"
            COLOR=9807270
            DESC="**${MSG}**"
          elif [ "$ANY_SERVICE" != "true" ]; then
            TITLE="âœ… Pipeline Completado (sin deploys)"
            COLOR=3066993
            DESC="**${MSG}**"
          else
            TITLE="âœ… Deploy Exitoso"
            COLOR=3066993
            DESC="**${MSG}**"
          fi

          JSON=$(cat <<EOFJ
          {
            "embeds": [{
              "title": "${TITLE}",
              "description": "${DESC}",
              "color": ${COLOR},
              "fields": [
                {"name": "Commit", "value": "[\`${SHORT}\`](https://github.com/${REPO}/commit/${SHA})", "inline": true},
                {"name": "Autor", "value": "${AUTHOR}", "inline": true},
                {"name": "Pipeline", "value": "${LINES}", "inline": false}
              ],
              "footer": {"text": "game-panel CI/CD"},
              "timestamp": "${TS}"
            }],
            "components": [{
              "type": 1,
              "components": [
                {"type": 2, "style": 5, "label": "Ver en Actions", "url": "https://github.com/${REPO}/actions/runs/${RUN_ID}", "emoji": {"name": "ğŸ”—"}},
                {"type": 2, "style": 5, "label": "Ver Commit", "url": "https://github.com/${REPO}/commit/${SHA}", "emoji": {"name": "ğŸ“"}}
              ]
            }]
          }
          EOFJ
          )
          curl -sf -X POST "https://discord.com/api/v10/channels/${CHANNEL_ID}/messages" \
            -H "Authorization: Bot ${BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$JSON"
